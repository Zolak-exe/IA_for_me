"""
Utilitaires pour sauvegarder et exporter les rÃ©sultats.
"""

import json
import logging
from pathlib import Path
from typing import Optional
from datetime import datetime

logger = logging.getLogger(__name__)


class SolutionExporter:
    """Exporte la solution gÃ©nÃ©rÃ©e dans diffÃ©rents formats"""
    
    def __init__(self, output_dir: str = "./outputs"):
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(exist_ok=True)
    
    def export_all(self, solution: dict, project_name: str = "project") -> dict:
        """Exporte la solution complÃ¨te"""
        
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        project_dir = self.output_dir / f"{project_name}_{timestamp}"
        project_dir.mkdir(exist_ok=True)
        
        files_created = {}
        
        # Export JSON des artefacts
        files_created['summary'] = self._export_summary(solution, project_dir)
        files_created['metrics'] = self._export_metrics(solution, project_dir)
        
        # Export individuels des artefacts
        if 'artifacts' in solution:
            artifacts = solution['artifacts']
            
            if artifacts.get('architecture'):
                files_created['architecture'] = self._save_file(
                    project_dir / "ARCHITECTURE.md",
                    self._format_architecture(artifacts['architecture'])
                )
            
            if artifacts.get('code'):
                files_created['code'] = self._save_file(
                    project_dir / "CODE.md",
                    artifacts['code']
                )
            
            if artifacts.get('tests'):
                files_created['tests'] = self._save_file(
                    project_dir / "TESTS.md",
                    artifacts['tests']
                )
            
            if artifacts.get('documentation'):
                files_created['documentation'] = self._save_file(
                    project_dir / "DOCUMENTATION.md",
                    artifacts['documentation']
                )
        
        logger.info(f"âœ… Solution exportÃ©e dans: {project_dir}")
        logger.info(f"   Fichiers crÃ©Ã©s: {len(files_created)}")
        
        return {
            "output_dir": str(project_dir),
            "files": files_created,
            "timestamp": timestamp
        }
    
    def _export_summary(self, solution: dict, output_dir: Path) -> str:
        """Exporte un rÃ©sumÃ© JSON"""
        summary = {
            "status": solution.get('status'),
            "score": solution.get('score'),
            "iteration": solution.get('iteration'),
            "generated_at": datetime.now().isoformat()
        }
        
        filepath = output_dir / "SUMMARY.json"
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(summary, f, indent=2, ensure_ascii=False)
        
        return str(filepath)
    
    def _export_metrics(self, solution: dict, output_dir: Path) -> str:
        """Exporte les mÃ©triques dÃ©taillÃ©es"""
        metrics_file = output_dir / "METRICS.json"
        
        with open(metrics_file, 'w', encoding='utf-8') as f:
            json.dump(solution.get('metrics', []), f, indent=2)
        
        return str(metrics_file)
    
    def _format_architecture(self, content: str) -> str:
        """Formate le contenu architecture avec header"""
        header = """# Architecture System

Generated by Multi-Agent System
"""
        return header + "\n" + content
    
    def _save_file(self, filepath: Path, content: str) -> str:
        """Sauvegarde un fichier"""
        try:
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(content)
            logger.debug(f"  âœ“ {filepath.name}")
            return str(filepath)
        except Exception as e:
            logger.error(f"  âœ— Erreur sauvegarde {filepath}: {e}")
            return ""


class ReportGenerator:
    """GÃ©nÃ¨re des rapports lisibles"""
    
    @staticmethod
    def generate_text_report(solution: dict) -> str:
        """GÃ©nÃ¨re un rapport texte"""
        
        report = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         RAPPORT SYSTÃˆME MULTI-AGENTS AUTO-CORRECTIF        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š RÃ‰SUMÃ‰ EXÃ‰CUTION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Status: {solution.get('status', 'N/A')}
Score final: {solution.get('score', 0):.1f}%
ItÃ©ration optimale: {solution.get('iteration', 0)}

ğŸ“ˆ MÃ‰TRIQUES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"""
        
        if 'metrics' in solution and solution['metrics']:
            report += f"\nItÃ©rations exÃ©cutÃ©es: {len(solution['metrics'])}\n"
            
            # DerniÃ¨re itÃ©ration
            last_metric = solution['metrics'][-1]
            report += f"""
DerniÃ¨re itÃ©ration:
  â€¢ Score global: {last_metric.get('overall_score', 0):.1f}%
  â€¢ QualitÃ© code: {last_metric.get('reviewer_score', 0):.1f}%
  â€¢ SÃ©curitÃ©: {last_metric.get('security_score', 0):.1f}%
  â€¢ ProblÃ¨mes: {last_metric.get('issues_count', 0)}
"""
        
        report += f"""

ğŸ¯ LIVRABLES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ Architecture systÃ¨me
âœ“ Code complet et fonctionnel
âœ“ Suite de tests unitaires
âœ“ Audit sÃ©curitÃ©
âœ“ Documentation complÃ¨te

ğŸ“¦ ARTEFACTS GÃ‰NÃ‰RÃ‰S
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ ARCHITECTURE.md - Design et patterns
â€¢ CODE.md - ImplÃ©mentation
â€¢ TESTS.md - Suite de tests
â€¢ DOCUMENTATION.md - Guide complet
â€¢ METRICS.json - MÃ©triques dÃ©taillÃ©es

"""
        
        return report
    
    @staticmethod
    def generate_html_report(solution: dict) -> str:
        """GÃ©nÃ¨re un rapport HTML"""
        
        score = solution.get('score', 0)
        iteration = solution.get('iteration', 0)
        
        html = f"""<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Rapport Multi-Agents</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }}
        .container {{ background: white; padding: 20px; border-radius: 8px; max-width: 1000px; }}
        h1 {{ color: #333; border-bottom: 3px solid #007bff; padding-bottom: 10px; }}
        .metric {{ display: inline-block; margin: 10px 20px 10px 0; }}
        .score {{ font-size: 32px; font-weight: bold; color: #007bff; }}
        .progress {{ width: 100%; height: 30px; background: #ddd; border-radius: 5px; overflow: hidden; }}
        .progress-bar {{ height: 100%; background: #28a745; width: {score}%; }}
        .status-ok {{ color: #28a745; font-weight: bold; }}
        .status-warning {{ color: #ffc107; font-weight: bold; }}
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– Rapport SystÃ¨me Multi-Agents</h1>
        
        <div class="metric">
            <div>Score Final</div>
            <div class="score">{score:.1f}%</div>
        </div>
        
        <div class="metric">
            <div>ItÃ©ration</div>
            <div class="score">{iteration}</div>
        </div>
        
        <h2>Progression QualitÃ©</h2>
        <div class="progress">
            <div class="progress-bar"></div>
        </div>
        
        <h2>Artefacts GÃ©nÃ©rÃ©s</h2>
        <ul>
            <li>âœ“ Architecture systÃ¨me</li>
            <li>âœ“ Code fonctionnel</li>
            <li>âœ“ Tests unitaires</li>
            <li>âœ“ Audit sÃ©curitÃ©</li>
            <li>âœ“ Documentation</li>
        </ul>
        
        <p style="color: #666; margin-top: 30px;">
            GÃ©nÃ©rÃ© par Multi-Agent System â€¢ {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}
        </p>
    </div>
</body>
</html>"""
        
        return html


class Dashboard:
    """Tableau de bord en temps rÃ©el"""
    
    @staticmethod
    def display_dashboard(orchestrator) -> str:
        """Affiche un dashboard actualisable"""
        
        dashboard = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          ğŸš€ SYSTÃˆME MULTI-AGENTS EN EXÃ‰CUTION              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ Ã‰TAT ACTUALISÃ‰
{datetime.now().strftime('%d/%m/%Y %H:%M:%S')}

ğŸ“Š PROGRESSION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ItÃ©ration: {orchestrator.iteration_count}/{orchestrator.max_iterations}

Meilleur score: {orchestrator.best_score:.1f}%
{"â–ˆ" * int(orchestrator.best_score / 5) + "â–‘" * (20 - int(orchestrator.best_score / 5))}

ğŸ¤– AGENTS ACTIFS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"""
        
        for name, agent in orchestrator.agents.items():
            dashboard += f"  â€¢ {agent}\n"
        
        if orchestrator.metrics_history:
            last_metric = orchestrator.metrics_history[-1]
            dashboard += f"""

ğŸ“ˆ DERNIÃˆRE ITÃ‰RATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Score global: {last_metric.overall_score:.1f}%
QualitÃ©: {last_metric.reviewer_score:.1f}%
SÃ©curitÃ©: {last_metric.security_score:.1f}%
ProblÃ¨mes: {last_metric.issues_count}
"""
        
        return dashboard
